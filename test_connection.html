<!DOCTYPE html>
<html>

    <head>

        <title>Bluetooth</title>
        <meta charset="utf-8">
        <meta http-equiv="Content-Language" content="pt-br">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    </head>

    <body>

        <h1 id="demo">Hello world Bluetooth!</h1>

        <button id="myBtn">Conectar</button>

        <button id="myBtn2">Mostrar valor</button>

    </body>

    <script>

        let botao = document.getElementById('myBtn');
        let botao2 = document.getElementById('myBtn2');
        let variavel;
        
        function mostrar_dados(dispositivo) {
            console.log(dispositivo.name);

            let para = document.createElement("p");
            let node = document.createTextNode("Dispositivo conectado!");

            para.appendChild(node);
            para.setAttribute("class", "mensagem");
            document.body.appendChild(para);
        }

        botao.addEventListener('click', function() {

            navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: ['battery_service']
            }).then(
                device => { 
                    
                    mostrar_dados(device);

                    return device.gatt.connect();
                }
            ).then(server => {
                return server.getPrimaryService('battery_service');
            }).then (service => {
                variavel = service.getCharacteristic('battery_level');
                return variavel;
            }).then (characteristic => {
                return characteristic.readValue();
            }).then (value => {
                console.log('Battery percentage is ' + value.getUint8(0));
            }).catch(error => {
                console.log("Error encountered: " + error);
            });

        });

        botao2.addEventListener('click', function() {
            variavel
            .then (characteristic => {
                return characteristic.readValue();
            })
            .then (value => {
                console.log('Battery percentage is ' + value.getUint8(0));
            })
            .catch(error => {
                console.log("Error encountered: " + error);
            });;
        });

    </script>

</html>